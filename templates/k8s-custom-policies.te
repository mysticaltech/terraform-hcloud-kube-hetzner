module k8s_custom_policies 1.0;

require {
    type container_t;
    type cert_t;
    type proc_t;
    type sysfs_t;
    type kernel_t;
    type init_t;
    type security_t;
    type unreserved_port_t;
    type kubernetes_port_t;
    type http_port_t;
    type hplip_port_t;
    type node_t;
    class dir { read search open getattr };
    class file { read open getattr };
    class lnk_file { read getattr };
    class tcp_socket { name_bind name_connect accept listen read write };
    class node { tcp_recv tcp_send };
    class peer recv;
    class filesystem getattr;
}

# Allow containers to read certificate directories and files
allow container_t cert_t:dir { read search open getattr };
allow container_t cert_t:file { read open getattr };

# Allow containers to read proc filesystem (needed for metrics-server filesystem collector)
allow container_t proc_t:file { read open getattr };
allow container_t proc_t:dir { read search open getattr };
allow container_t proc_t:lnk_file { read getattr };
allow container_t proc_t:filesystem getattr;

# Also allow sysfs access which is often needed alongside proc
allow container_t sysfs_t:file { read open getattr };
allow container_t sysfs_t:dir { read search open getattr };
allow container_t sysfs_t:lnk_file { read getattr };
allow container_t sysfs_t:filesystem getattr;

# Allow containers to bind to kubernetes ports (including 10250 for metrics-server)
allow container_t kubernetes_port_t:tcp_socket { name_bind name_connect accept listen };

# Allow containers to bind to hplip ports (including 9100 for node-exporter)
allow container_t hplip_port_t:tcp_socket { name_bind name_connect accept listen };

# Allow containers to bind to unreserved high ports
allow container_t unreserved_port_t:tcp_socket { name_bind name_connect accept listen };

# Allow container-to-container communication (needed for readiness probes)
allow container_t container_t:tcp_socket { name_connect accept };
allow container_t container_t:peer recv;

# Allow containers to use network nodes
allow container_t node_t:node { tcp_recv tcp_send };

# Allow containers to bind to http ports (some exporters may use these)
allow container_t http_port_t:tcp_socket { name_bind name_connect accept listen };

# Allow containers to read kernel TCP sockets (needed for metrics-server to read /proc/net/tcp)
allow container_t kernel_t:tcp_socket { read write };

# Allow containers to read SELinux status (needed for node-exporter)
allow container_t security_t:file { read open getattr };

# Allow containers to access init process information (needed for node-exporter to read mountinfo, etc.)
allow container_t init_t:dir { read search open getattr };
allow container_t init_t:file { read open getattr };
allow container_t init_t:lnk_file { read getattr };
