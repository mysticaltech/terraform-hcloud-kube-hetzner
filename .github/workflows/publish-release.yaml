---
name: Publish a new Github Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  Release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for contributor extraction

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for this release
        run: |
          # Extract the [Unreleased] section from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Get content between [Unreleased] and the next ## heading
            awk '/^## \[Unreleased\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > changelog_section.md

            if [ -s changelog_section.md ]; then
              echo "Found changelog content:"
              cat changelog_section.md
            else
              echo "No unreleased changelog content found"
              : > changelog_section.md
            fi
          else
            echo "No CHANGELOG.md found"
            : > changelog_section.md
          fi

      - name: Generate contributors list
        env:
          PREV_TAG: ${{ steps.prev_tag.outputs.tag }}
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${PREV_TAG}" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          COMMITS=$(git log "${RANGE}" --format='%H')

          # Pull request authors mapped from commits in range.
          # This preserves attribution when changes were merged with squash.
          PR_AUTHORS=$(
            for sha in ${COMMITS}; do
              gh api "repos/${GITHUB_REPOSITORY}/commits/${sha}/pulls" \
                -H "Accept: application/vnd.github+json" \
                --jq '.[].user.login' 2>/dev/null || true
            done | sed '/^$/d' | sort -u
          )

          COMMIT_AUTHORS=$(git log "${RANGE}" --format='%an' | sed '/^$/d' | sort -u)
          COAUTHORS=$(
            git log "${RANGE}" --format='%b' \
              | grep -i "co-authored-by:" \
              | sed -E 's/.*:[[:space:]]*//' \
              | sed -E 's/[[:space:]]*<.*//' \
              | sed '/^$/d' \
              | sort -u || true
          )

          ALL_CONTRIBUTORS=$(
            {
              printf '%s\n' "${PR_AUTHORS}" | sed 's/^/@/'
              printf '%s\n' "${COMMIT_AUTHORS}"
              printf '%s\n' "${COAUTHORS}"
            } | sed '/^$/d' | awk '!seen[tolower($0)]++'
          )

          # Write to file for multi-line output
          {
            echo "## ðŸ‘¥ Contributors"
            echo ""
            echo "Thanks to all contributors who made this release possible:"
            echo ""
            echo "_Attribution includes pull request authors mapped from commits, so squashed PR implementers are credited._"
            echo ""

            if [ -n "${PR_AUTHORS}" ]; then
              echo "### Pull Request Authors"
              echo ""
              printf '%s\n' "${PR_AUTHORS}" | sed '/^$/d' | sed 's/^/* @/'
              echo ""
            fi

            echo "### Full Contributor List"
            echo ""
            if [ -n "${ALL_CONTRIBUTORS}" ]; then
              printf '%s\n' "${ALL_CONTRIBUTORS}" | sed '/^$/d' | sed 's/^/* /'
            else
              echo "* No contributors found in this release range."
            fi
          } > contributors.md

          echo "Generated contributors list:"
          cat contributors.md

      - name: Combine release notes
        run: |
          # Combine changelog + contributors into final release body
          {
            cat changelog_section.md
            echo ""
            cat contributors.md
          } > release_body.md

          echo "Final release body:"
          cat release_body.md

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          bodyFile: release_body.md
          appendBody: true
