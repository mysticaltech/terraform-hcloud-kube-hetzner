name: Generate terraform docs
on:
  push:
    branches:
      - master
      - staging

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install terraform-docs
      env:
        TERRAFORM_DOCS_VERSION: v0.20.0
      run: |
        curl -fsSL -o /tmp/terraform-docs.tar.gz \
          "https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-linux-amd64.tar.gz"
        tar -xzf /tmp/terraform-docs.tar.gz -C /tmp terraform-docs
        sudo install -m 0755 /tmp/terraform-docs /usr/local/bin/terraform-docs
        terraform-docs --version

    - name: Verify terraform docs are up to date
      run: |
        terraform-docs markdown table --config .terraform-docs.yml --output-mode inject --output-file docs/terraform.md .
        git diff -- docs/terraform.md
        git diff --exit-code -- docs/terraform.md
